# 5.2 System Architecture


## â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
## â•‘       ğŸ“Š INSERT FIGURE 5.1 - SYSTEM ARCHITECTURE DIAGRAM ğŸ“Š   â•‘
## â•‘                                                                 â•‘
## â•‘  Three-tier architecture showing:                              â•‘
## â•‘  â€¢ Presentation: Flutter Mobile App + React Admin Dashboard    â•‘
## â•‘  â€¢ Application: Firebase Cloud Functions + M-Pesa API          â•‘
## â•‘  â€¢ Data: Cloud Firestore + Firebase Auth                       â•‘
## â•‘  â€¢ Communication flows and security boundaries                 â•‘
## â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


## Presentation Layer

### Flutter Mobile Application

The Flutter mobile application provides the primary student interface for menu browsing, ordering, payment, tracking, and loyalty engagement. Built using Flutter framework, it compiles to native code for iOS and Android from a single Dart codebase.

The application follows **BLoC (Business Logic Component) pattern**, separating UI from business logic and state management.

**Key components**:
- **Authentication Module**: User registration, login, password reset using Firebase Authentication SDK
- **Menu Browser**: Categorized menu display with search and filtering
- **Shopping Cart**: Order composition with quantities and real-time pricing
- **Checkout Engine**: Multi-step checkout with delivery preferences and payment
- **Payment Integration**: M-Pesa Daraja API interface for STK Push payments
- **Order Tracking**: Real-time status monitoring using Firestore listeners
- **Loyalty Manager**: Points balance, transaction history, redemption
- **Profile Manager**: Profile viewing, editing, account settings

The application implements **offline-first architecture** for menu browsing, caching menu data locally using shared preferences and SQLite.

### React Administrative Dashboard

The administrative dashboard provides cafeteria staff and administrators with order management, menu administration, and analytics. Built using React with Next.js, it delivers a responsive web interface accessible from any browser.

**Dashboard components**:
- **Order Queue Display**: Real-time pending orders sorted by priority
- **Order Status Management**: Interface for updating order preparation status
- **Menu Administration**: CRUD operations for menu items with image uploads
- **Inventory Management**: Mark items available/unavailable, adjust prices
- **Analytics Dashboard**: Visualizations showing orders, revenue, popular items
- **User Management**: View registered users, monitor loyalty points

## Application Layer

The application layer implements server-side business logic through **Firebase Cloud Functions**, serverless functions executing in Google's managed infrastructure.

**Key Cloud Functions**:
- **Payment Verification**: Validates M-Pesa callbacks, confirms authenticity, updates order payment status
- **Loyalty Points Calculator**: Calculates earned points, applies multipliers, updates loyalty balance
- **Order Notification**: Sends push notifications when order status changes
- **Analytics Aggregator**: Calculates daily/weekly sales totals and revenue metrics
- **Menu Validation**: Validates menu item data ensuring business rules compliance

The serverless architecture provides automatic scalingâ€”during peak hours, Google's infrastructure provisions additional instances. During off-peak, functions scale to zero.

## Data Layer

The data layer combines **Cloud Firestore** for primary data persistence with **Firebase Authentication** for identity management and **M-Pesa Daraja API** for payment processing.

### Cloud Firestore Database

Firestore provides primary data storage for users, menu items, orders, and loyalty transactions. As a NoSQL document database, it organizes data into collections with flexible schema design.

Firestore's real-time synchronization enables live updatesâ€”when staff update order status, user mobile apps receive changes instantly through snapshot listeners.

Security rules enforce access control server-side: users read only their own data, staff update orders but not historical data, administrators have comprehensive access.

### Firebase Authentication

Firebase Authentication manages user identities, password storage, session tokens, and email verification. The system uses email/password authentication with potential for future social login integration. Firebase handles security best practices including bcrypt password hashing.

### M-Pesa Daraja API Integration

M-Pesa integration uses Safaricom's Daraja API **STK Push (Lipa na M-Pesa Online)** functionality. When users initiate payment, Cloud Functions call Daraja API prompting users to authorize payment on phones. Daraja sends payment confirmation callbacks to webhooks, which Cloud Functions verify and process.

This integration delegates payment security and PCI compliance to Safaricom's infrastructure.

## Communication Protocols

All communication between layers utilizes industry-standard protocols:
- **HTTPS/TLS**: All client-server communication encrypted end-to-end
- **REST API**: Cloud Functions expose RESTful HTTP endpoints
- **WebSocket (Firestore Listeners)**: Real-time database synchronization
- **OAuth 2.0**: M-Pesa Daraja API authentication with bearer tokens
- **JSON**: All data serialization for universal compatibility

---

**Word Count**: ~650 words (condensed from ~1,224 words)  
**Status**: âœ… Condensed (47% reduction)  
**Note**: âš ï¸ **DIAGRAM Required** - Insert Figure 5.1 System Architecture Diagram at marker above
