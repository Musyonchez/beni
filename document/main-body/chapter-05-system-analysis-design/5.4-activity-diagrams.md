# 5.4 Activity Diagrams

Activity diagrams model the dynamic behavior of the system by illustrating workflows, business processes, and algorithmic logic including sequential activities, decision points, parallel processes, and control flow. These diagrams provide detailed insight into how specific use cases execute from start to completion, highlighting the procedural steps and conditional logic governing system operations.

## User Registration and Login Workflow

**[DIAGRAM PLACEHOLDER: Figure 5.6 - User Registration Activity Diagram]**  
*A UML activity diagram showing the user registration workflow with:*
- *Start node (filled circle)*
- *User enters registration details (name, email, phone, password) - activity rectangle*
- *System validates input format - activity rectangle*
- *Decision diamond: "Input valid?"*
  - *No branch → Display validation errors → Return to input form*
  - *Yes branch → Continue*
- *System checks email uniqueness - activity rectangle*
- *Decision diamond: "Email already exists?"*
  - *Yes branch → Display "Email already registered" error → Return to input*
  - *No branch → Continue*
- *System creates user account in Firestore - activity rectangle*
- *System sends verification email via Firebase Auth - activity rectangle*
- *Fork (parallel paths):*
  - *Initialize loyalty points = 0*
  - *Create default user profile*
  - *Log registration event*
- *Join (merge parallel paths)*
- *Display "Registration successful, check email" message - activity rectangle*
- *End node (filled circle with border)*

The registration workflow implements comprehensive validation ensuring data quality and preventing duplicate accounts. Email format validation uses regex pattern matching, phone number validation confirms Kenyan format (+254 or 07xx), and password strength requirements enforce minimum 8 characters with at least one number. The email uniqueness check prevents users from creating multiple accounts with the same email, which could complicate order tracking and loyalty points management.

**[DIAGRAM PLACEHOLDER: Figure 5.7 - User Login Activity Diagram]**  
*A UML activity diagram showing the login workflow with:*
- *Start node*
- *User enters email and password - activity rectangle*
- *System calls Firebase Authentication - activity rectangle*
- *Decision diamond: "Credentials valid?"*
  - *No branch → Increment failed login counter → Decision: "Failed attempts > 3?" → Yes → Lock account for 15 minutes → Display error; No → Display "Invalid credentials" → Return to login*
  - *Yes branch → Continue*
- *System retrieves user profile from Firestore - activity rectangle*
- *System generates session token - activity rectangle*
- *Decision diamond: "Email verified?"*
  - *No branch → Display "Please verify email" warning → Allow limited access*
  - *Yes branch → Continue*
- *Fork (parallel paths):*
  - *Load user preferences*
  - *Fetch loyalty points balance*
  - *Retrieve cart items (if any)*
  - *Check for pending orders*
- *Join*
- *Navigate to Home screen - activity rectangle*
- *End node*

The login workflow includes security features like failed attempt limiting to prevent brute force attacks and email verification checking to ensure account authenticity. Session token generation uses Firebase Authentication's built-in JWT (JSON Web Token) mechanism, providing secure, stateless authentication suitable for mobile applications.

## Order Placement Workflow

**[DIAGRAM PLACEHOLDER: Figure 5.8 - Complete Order Placement Activity Diagram]**  
*A comprehensive UML activity diagram showing the end-to-end ordering process with:*
- *Start node*
- *User browses menu - activity rectangle*
- *Decision diamond: "Item selected?"*
  - *No branch → Continue browsing → Loop back*
  - *Yes branch → Continue*
- *User adds item to cart (specify quantity) - activity rectangle*
- *System calculates cart subtotal - activity rectangle*
- *Decision diamond: "Add more items?"*
  - *Yes branch → Return to browsing*
  - *No branch → Proceed to checkout*
- *User reviews cart contents - activity rectangle*
- *Decision diamond: "Apply loyalty points?"*
  - *Yes branch → Calculate discount → Update total*
  - *No branch → Use original total*
- *User enters delivery preferences (pickup time, special instructions) - activity rectangle*
- *System displays order summary with final total - activity rectangle*
- *User confirms order - activity rectangle*
- *System creates order record in Firestore (status = "Pending Payment") - activity rectangle*
- *Proceed to payment workflow (see Figure 5.9)*

This workflow demonstrates the shopping cart pattern common in e-commerce applications, adapted for food ordering context. The loyalty points decision point allows optional discount application without forcing users to redeem points on every order. The order creation before payment completion enables payment abandonment tracking—orders created but never paid indicate potential friction in the payment process.

## M-Pesa Payment Processing Workflow

**[DIAGRAM PLACEHOLDER: Figure 5.9 - M-Pesa Payment Processing Activity Diagram]**  
*A detailed activity diagram showing payment processing with swim lanes for Customer, Mobile App, Cloud Functions, and M-Pesa:*
- *Customer lane: Start → Confirm order → Receive STK Push prompt on phone → Enter M-Pesa PIN → Receive confirmation*
- *Mobile App lane: Display order summary → Request payment → Show "Waiting for payment..." spinner → Receive payment result → Display confirmation/error → Navigate to order tracking*
- *Cloud Functions lane: Receive payment request → Generate OAuth token from M-Pesa → Submit STK Push request → Wait for callback → Validate callback signature → Update order payment status → Send push notification → Trigger loyalty points calculation*
- *M-Pesa lane: Receive STK Push request → Send USSD prompt to customer phone → Receive PIN entry → Process transaction → Send callback to webhook → Return transaction reference*
- *Decision diamonds showing: "Payment successful?", "OAuth token valid?", "Callback authentic?", "Sufficient balance?"*

The payment workflow involves complex interaction between multiple systems requiring careful orchestration. The STK Push mechanism provides better user experience than manual M-Pesa transfers by automatically prompting payment without users needing to remember paybill numbers or account numbers. Callback validation prevents fraudulent payment confirmation attempts—Cloud Functions verify callback requests originate from M-Pesa's IP addresses and contain valid signatures before updating order status.

## Order Status Update Workflow

**[DIAGRAM PLACEHOLDER: Figure 5.10 - Order Status Update Activity Diagram]**  
*Activity diagram showing order lifecycle with staff interactions:*
- *Start: Order created (status = "Pending Payment")*
- *Wait for payment confirmation*
- *Decision: "Payment confirmed within 5 minutes?"*
  - *No → Cancel order → Notify customer → End*
  - *Yes → Update status to "Payment Confirmed"*
- *Order appears in staff queue - activity rectangle*
- *Staff views order details - activity rectangle*
- *Staff begins preparation → Update status to "Preparing" → Send push notification to customer*
- *Parallel activities: Prepare food items (concurrent preparation of multiple items)*
- *Staff marks items complete*
- *Decision: "All items prepared?"*
  - *No → Continue preparing*
  - *Yes → Update status to "Ready for Pickup"*
- *Send push notification to customer - activity rectangle*
- *Wait for customer pickup*
- *Staff confirms pickup → Update status to "Completed"*
- *Trigger loyalty points calculation - activity rectangle*
- *Fork: Update analytics / Archive order / Send feedback request*
- *End*

This workflow models the order lifecycle from creation through completion, showing state transitions and notification triggers. The 5-minute payment timeout prevents unpaid orders from cluttering the queue. The parallel preparation activities recognize that kitchen staff can prepare multiple components simultaneously (cooking rice while grilling chicken), improving overall throughput.

## Loyalty Points Calculation and Redemption Workflow

**[DIAGRAM PLACEHOLDER: Figure 5.11 - Loyalty Points Calculation Activity Diagram]**  
*Activity diagram for loyalty points processing:*
- *Start: Order completed*
- *Retrieve order total amount - activity rectangle*
- *Calculate base points (total ÷ 100, rounded down) - activity rectangle*
- *Decision: "Special promotion active?"*
  - *Yes → Apply multiplier (2x, 3x) → Recalculate points*
  - *No → Use base points*
- *Decision: "Order total ≥ minimum threshold (200 KES)?"*
  - *No → Points = 0 → Skip earning*
  - *Yes → Continue*
- *Retrieve user's current points balance - activity rectangle*
- *Add earned points to balance - activity rectangle*
- *Create loyalty transaction record (type = "earned", source = order ID) - activity rectangle*
- *Send notification: "You earned X points!" - activity rectangle*
- *End*

**[DIAGRAM PLACEHOLDER: Figure 5.12 - Loyalty Points Redemption Activity Diagram]**  
*Activity diagram for redeeming points:*
- *Start: User views cart during checkout*
- *Retrieve user's available points balance - activity rectangle*
- *Display redemption option: "Redeem 100 points for 50 KES discount" - activity rectangle*
- *Decision: "User chooses to redeem?"*
  - *No → Proceed without discount → End*
  - *Yes → Continue*
- *Decision: "Sufficient points balance?"*
  - *No → Display "Insufficient points" error → End*
  - *Yes → Continue*
- *Calculate discount amount (points ÷ 2 KES) - activity rectangle*
- *Apply discount to order total - activity rectangle*
- *Reserve points (mark as pending redemption) - activity rectangle*
- *When order completes:*
  - *Deduct points from balance*
  - *Create loyalty transaction record (type = "redeemed", applied to order ID)*
- *When order cancels:*
  - *Release reserved points*
- *End*

The loyalty program workflows implement a simple but effective points system: earn 1 point per 100 KES spent, redeem 100 points for 50 KES discount (50% value to encourage continued spending rather than immediate full-value redemption). The points reservation mechanism during checkout prevents race conditions where users might redeem the same points on multiple simultaneous orders.

---

**Word Count**: ~720 words  
**Status**: ✅ Complete
