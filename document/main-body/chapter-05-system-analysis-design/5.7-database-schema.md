# 5.7 Database Schema

The system utilizes **Cloud Firestore**, a NoSQL document database, as its primary data store. Unlike traditional relational databases with fixed schemas enforced at the database level, Firestore employs a flexible document-oriented model where each document is a JSON-like object containing key-value pairs. Documents organize into collections, which can contain subcollections, enabling hierarchical data structures. While this flexibility allows schema evolution without migrations, careful schema design remains critical for performance, data consistency, and query efficiency.

## Database Architecture Overview

**[DIAGRAM PLACEHOLDER: Figure 5.21 - Firestore Database ER Diagram]**  
*An entity-relationship diagram showing Firestore collections and their relationships:*
- *Top level: Users collection, MenuItems collection, Orders collection, Payments collection, LoyaltyTransactions collection*
- *Users collection containing user documents*
- *MenuItems collection containing menu item documents*
- *Orders collection containing order documents, with subcollection OrderItems*
- *Payments collection with references to Orders*
- *LoyaltyTransactions collection with references to Users*
- *Lines showing relationships with cardinality (1:N, 1:1)*
- *Foreign key references shown as dashed arrows labeled with field names (userId, orderId, etc.)*

## Collection Schemas

### Users Collection

**Path**: `/users/{userId}`

The Users collection stores all registered user accounts with authentication details, profile information, and loyalty program data.

**Document Structure**:
```json
{
  "userId": "string (document ID, matches Firebase Auth UID)",
  "name": "string (full name)",
  "email": "string (unique, lowercase)",
  "phoneNumber": "string (format: +254XXXXXXXXX)",
  "profileImageUrl": "string (Cloud Storage URL, optional)",
  "loyaltyPoints": "number (integer, default 0)",
  "role": "string (enum: 'customer', 'staff', 'admin', default 'customer')",
  "emailVerified": "boolean (from Firebase Auth)",
  "accountStatus": "string (enum: 'active', 'suspended', 'deleted')",
  "preferences": {
    "notifications": "boolean",
    "newsletter": "boolean",
    "favoriteCategories": "array<string>"
  },
  "createdAt": "timestamp (Firestore serverTimestamp)",
  "updatedAt": "timestamp",
  "lastLoginAt": "timestamp"
}
```

**Indexes**:
- `email` (ascending) - for uniqueness checks during registration
- `phoneNumber` (ascending) - for duplicate prevention
- `loyaltyPoints` (descending) - for leaderboard queries (future feature)

**Security Rules**:
```javascript
// Users can read only their own document
match /users/{userId} {
  allow read: if request.auth.uid == userId;
  allow create: if request.auth.uid == userId;
  allow update: if request.auth.uid == userId && 
                   !request.resource.data.diff(resource.data).affectedKeys()
                   .hasAny(['loyaltyPoints', 'role']);
  // Only admin can modify loyalty points and roles
}
```

**Sample Document**:
```json
{
  "userId": "abc123xyz",
  "name": "John Kamau",
  "email": "john.kamau@students.usiu.ac.ke",
  "phoneNumber": "+254712345678",
  "profileImageUrl": "https://storage.googleapis.com/...",
  "loyaltyPoints": 250,
  "role": "customer",
  "emailVerified": true,
  "accountStatus": "active",
  "preferences": {
    "notifications": true,
    "newsletter": false,
    "favoriteCategories": ["lunch", "beverages"]
  },
  "createdAt": "2026-01-15T09:30:00Z",
  "updatedAt": "2026-01-28T14:20:00Z",
  "lastLoginAt": "2026-01-29T08:15:00Z"
}
```

### MenuItems Collection

**Path**: `/menuItems/{itemId}`

Stores the cafeteria's menu catalog with all available food and beverage items.

**Document Structure**:
```json
{
  "itemId": "string (auto-generated document ID)",
  "name": "string (display name)",
  "description": "string (detailed description)",
  "category": "string (enum: 'breakfast', 'lunch', 'dinner', 'snacks', 'beverages')",
  "price": "number (double, Kenya Shillings)",
  "imageUrl": "string (Cloud Storage URL)",
  "preparationTime": "number (integer, minutes)",
  "isAvailable": "boolean (in stock)",
  "isActive": "boolean (soft delete flag)",
  "nutritionalInfo": {
    "calories": "number (optional)",
    "protein": "number (grams, optional)",
    "carbs": "number (grams, optional)",
    "fat": "number (grams, optional)"
  },
  "allergens": "array<string> (['peanuts', 'dairy', 'gluten', etc.])",
  "tags": "array<string> (['vegetarian', 'vegan', 'spicy', 'popular'])",
  "popularityScore": "number (calculated metric for sorting)",
  "createdAt": "timestamp",
  "updatedAt": "timestamp",
  "createdBy": "string (admin userId)"
}
```

**Indexes**:
- `category` (ascending), `isAvailable` (ascending), `name` (ascending) - for category browsing
- `isActive` (ascending), `popularityScore` (descending) - for homepage popular items
- `price` (ascending) - for price range filtering

**Sample Document**:
```json
{
  "itemId": "item_chips_masala_001",
  "name": "Chips Masala",
  "description": "Golden crispy French fries tossed in aromatic masala spices with peppers and onions",
  "category": "lunch",
  "price": 150.00,
  "imageUrl": "https://storage.googleapis.com/.../chips-masala.jpg",
  "preparationTime": 15,
  "isAvailable": true,
  "isActive": true,
  "nutritionalInfo": {
    "calories": 420,
    "protein": 6,
    "carbs": 58,
    "fat": 18
  },
  "allergens": [],
  "tags": ["popular", "vegetarian", "spicy"],
  "popularityScore": 87,
  "createdAt": "2026-01-10T10:00:00Z",
  "updatedAt": "2026-01-28T11:30:00Z",
  "createdBy": "admin_001"
}
```

### Orders Collection

**Path**: `/orders/{orderId}`

Contains all customer orders from placement through completion.

**Document Structure**:
```json
{
  "orderId": "string (auto-generated)",
  "userId": "string (reference to Users collection)",
  "userName": "string (denormalized for quick display)",
  "userPhone": "string (denormalized for contact)",
  "items": "array<object> (OrderItem objects)",
  "subtotal": "number (before discounts)",
  "loyaltyDiscount": "number (discount amount from redeemed points)",
  "pointsRedeemed": "number (integer, points used)",
  "total": "number (final amount after discounts)",
  "status": "string (enum: 'pending_payment', 'paid', 'preparing', 'ready', 'completed', 'cancelled')",
  "paymentStatus": "string (enum: 'pending', 'completed', 'failed')",
  "paymentId": "string (reference to Payments collection)",
  "deliveryPreferences": {
    "pickupTime": "timestamp (requested pickup time)",
    "specialInstructions": "string (optional)"
  },
  "estimatedReadyTime": "timestamp (calculated)",
  "actualReadyTime": "timestamp (nullable)",
  "createdAt": "timestamp",
  "updatedAt": "timestamp",
  "completedAt": "timestamp (nullable)"
}
```

**Items Array Structure**:
```json
{
  "itemId": "string (reference to MenuItem)",
  "name": "string (denormalized)",
  "quantity": "number (integer)",
  "unitPrice": "number (price at time of order)",
  "subtotal": "number (quantity × unitPrice)",
  "specialInstructions": "string (optional, e.g., 'no onions')"
}
```

**Indexes**:
- `userId` (ascending), `createdAt` (descending) - for user order history
- `status` (ascending), `createdAt` (ascending) - for staff queue display
- `createdAt` (descending) - for recent orders analytics

**Sample Document**:
```json
{
  "orderId": "order_20260129_001",
  "userId": "abc123xyz",
  "userName": "John Kamau",
  "userPhone": "+254712345678",
  "items": [
    {
      "itemId": "item_chips_masala_001",
      "name": "Chips Masala",
      "quantity": 1,
      "unitPrice": 150.00,
      "subtotal": 150.00,
      "specialInstructions": "Extra spicy"
    },
    {
      "itemId": "item_soda_cola_500",
      "name": "Coca-Cola 500ml",
      "quantity": 1,
      "unitPrice": 80.00,
      "subtotal": 80.00,
      "specialInstructions": ""
    }
  ],
  "subtotal": 230.00,
  "loyaltyDiscount": 50.00,
  "pointsRedeemed": 100,
  "total": 180.00,
  "status": "preparing",
  "paymentStatus": "completed",
  "paymentId": "pay_mpesa_abc123",
  "deliveryPreferences": {
    "pickupTime": "2026-01-29T13:00:00Z",
    "specialInstructions": "Please call when ready"
  },
  "estimatedReadyTime": "2026-01-29T12:55:00Z",
  "actualReadyTime": null,
  "createdAt": "2026-01-29T12:30:00Z",
  "updatedAt": "2026-01-29T12:35:00Z",
  "completedAt": null
}
```

### Payments Collection

**Path**: `/payments/{paymentId}`

Records all payment transactions with M-Pesa integration details.

**Document Structure**:
```json
{
  "paymentId": "string (auto-generated)",
  "orderId": "string (reference to Orders)",
  "userId": "string (reference to Users)",
  "amount": "number (transaction amount)",
  "paymentMethod": "string (enum: 'mpesa', 'cash')",
  "phoneNumber": "string (M-Pesa phone number)",
  "mpesaCheckoutRequestId": "string (from STK Push)",
  "mpesaTransactionId": "string (from callback)",
  "mpesaReceiptNumber": "string (M-Pesa confirmation code)",
  "status": "string (enum: 'initiated', 'pending', 'completed', 'failed', 'refunded')",
  "failureReason": "string (nullable, error details)",
  "initiatedAt": "timestamp",
  "completedAt": "timestamp (nullable)",
  "callbackData": "object (raw M-Pesa callback for debugging)"
}
```

**Sample Document**:
```json
{
  "paymentId": "pay_mpesa_abc123",
  "orderId": "order_20260129_001",
  "userId": "abc123xyz",
  "amount": 180.00,
  "paymentMethod": "mpesa",
  "phoneNumber": "+254712345678",
  "mpesaCheckoutRequestId": "ws_CO_29012026123045678",
  "mpesaTransactionId": "OBK1ABC2XY",
  "mpesaReceiptNumber": "OBK1ABC2XY",
  "status": "completed",
  "failureReason": null,
  "initiatedAt": "2026-01-29T12:30:30Z",
  "completedAt": "2026-01-29T12:30:55Z",
  "callbackData": { /* M-Pesa callback JSON */ }
}
```

### LoyaltyTransactions Collection

**Path**: `/loyaltyTransactions/{transactionId}`

Audit trail of all loyalty points earned and redeemed.

**Document Structure**:
```json
{
  "transactionId": "string (auto-generated)",
  "userId": "string (reference to Users)",
  "points": "number (integer, positive for earned, negative for redeemed)",
  "type": "string (enum: 'earned', 'redeemed', 'expired', 'adjusted')",
  "sourceOrderId": "string (nullable, reference to Orders if applicable)",
  "description": "string (human-readable explanation)",
  "balanceBefore": "number (user's balance before transaction)",
  "balanceAfter": "number (user's balance after transaction)",
  "createdAt": "timestamp",
  "expiresAt": "timestamp (nullable, for earned points with expiration)"
}
```

**Sample Document**:
```json
{
  "transactionId": "loyalty_tx_12345",
  "userId": "abc123xyz",
  "points": -100,
  "type": "redeemed",
  "sourceOrderId": "order_20260129_001",
  "description": "Redeemed 100 points for 50 KES discount on Order #order_20260129_001",
  "balanceBefore": 250,
  "balanceAfter": 150,
  "createdAt": "2026-01-29T12:30:25Z",
  "expiresAt": null
}
```

## Data Relationships and Integrity

Firestore does not enforce foreign key constraints at the database level, so the application code must maintain referential integrity:

- **Users ↔ Orders**: One-to-many. Orders contain `userId` field. Application validates user exists before creating order.
- **Orders ↔ Payments**: One-to-one. Payment contains `orderId` reference. orders contain `paymentId` back-reference for quick lookup.
- **Orders ↔ MenuItems**: Many-to-many (through items array). Items array denormalizes item names and prices to preserve historical order data even if menu items change.
- **Users ↔ LoyaltyTransactions**: One-to-many. Transactions contain `userId`. Cloud Functions ensure atomic points balance updates.

**Denormalization Strategy**: The schema denormalizes frequently-accessed data (user names in orders, item names in order items) to minimize complex joins and improve query performance. This trades storage space for read performance—a common NoSQL pattern.

---

**Word Count**: ~1,240 words  
**Status**: ✅ Complete
